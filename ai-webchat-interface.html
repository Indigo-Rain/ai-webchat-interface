<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'user-blue': '#007AFF',
                        'wechat-gray': '#F2F2F2',
                        'wechat-text': '#1D1D1F',
                        'wechat-time': '#86909C'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'typing': 'typing 1.4s infinite both'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        typing: {
                            '0%, 100%': { opacity: '0.2' },
                            '50%': { opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide {
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .message-bubble-left {
                border-radius: 18px 18px 18px 4px;
            }
            .message-bubble-right {
                border-radius: 18px 18px 4px 18px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden transition-colors duration-300 dark:bg-gray-900">
    <!-- ‰∏ªÂÆπÂô® -->
    <div class="flex flex-col h-full">
        <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
        <header class="bg-white shadow-sm z-10 transition-colors duration-300 dark:bg-gray-800">
            <div class="flex items-center justify-between px-4 py-3">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 rounded-full overflow-hidden bg-gray-400 flex items-center justify-center" id="chatAvatar">
                            <i class="fa fa-bullseye text-white text-lg"></i>
                        </div>
                        <div>
                            <h1 class="text-lg font-semibold text-wechat-text dark:text-white" id="chatTitle">Êô∫ËÉΩËÅäÂ§©Âä©Êâã</h1>
                            <p class="text-xs text-wechat-time dark:text-gray-400" id="onlineStatus">üü¢ Âú®Á∫ø</p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="themeToggle" class="p-2 rounded-full hover:bg-gray-200 transition-colors dark:hover:bg-gray-700">
                        <i class="fa fa-moon-o text-wechat-text dark:text-white dark:hidden"></i>
                        <i class="fa fa-sun-o text-white hidden dark:inline"></i>
                    </button>
                    <button id="settingsBtn" class="p-2 rounded-full hover:bg-gray-200 transition-colors dark:hover:bg-gray-700">
                        <i class="fa fa-cog text-wechat-text dark:text-white"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- ËÅäÂ§©Âå∫Âüü -->
        <main class="flex-1 overflow-y-auto scrollbar-hide p-4 transition-colors duration-300 dark:bg-gray-900" id="chatContainer">
            <div class="max-w-4xl mx-auto space-y-6" id="messageList">
                <!-- ÂàùÂßã‰∏∫Á©∫ÔºåÊ≤°ÊúâÊ¨¢ËøéÊ∂àÊÅØÂíåÈ¶ñÂè•ÂèëË®Ä -->
            </div>
        </main>

        <!-- ËæìÂÖ•Âå∫Âüü -->
        <footer class="bg-white border-t border-gray-200 p-3 transition-colors duration-300 dark:bg-gray-800 dark:border-gray-700">
            <div class="max-w-4xl mx-auto">
                <div class="flex items-center space-x-2">
                    <button id="emojiBtn" class="p-2 rounded-full hover:bg-gray-200 transition-colors dark:hover:bg-gray-700">
                        <i class="fa fa-smile-o text-wechat-text dark:text-white"></i>
                    </button>
                    <div class="flex-1 relative">
                        <textarea 
                            id="messageInput" 
                            placeholder="ËØ∑ËæìÂÖ•Ê∂àÊÅØ..." 
                            class="w-full px-4 py-2 bg-gray-100 rounded-full focus:outline-none focus:ring-2 focus:ring-user-blue/20 resize-none h-12 transition-colors duration-300 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400"
                            rows="1"
                        ></textarea>
                    </div>
                    <button id="sendBtn" class="w-10 h-10 rounded-full bg-user-blue text-white flex items-center justify-center hover:bg-blue-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fa fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </footer>
    </div>

    <!-- Ë°®ÊÉÖÈù¢Êùø -->
    <div id="emojiPanel" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-white rounded-2xl shadow-2xl w-[90%] max-w-md z-50 hidden transition-colors duration-300 dark:bg-gray-800">
        <div class="p-4">
            <div class="emoji-content h-auto max-h-48 overflow-y-auto scrollbar-hide" id="emojiContent">
                <!-- Ë°®ÊÉÖÂÜÖÂÆπ -->
            </div>
        </div>
    </div>

    <!-- ËÆæÁΩÆÈù¢Êùø -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 dark:bg-black/70">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[80vh] overflow-y-auto scrollbar-hide transition-colors duration-300 dark:bg-gray-800">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-wechat-text dark:text-white">ËÅäÂ§©ËÆæÁΩÆ</h2>
                    <button id="closeSettings" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <i class="fa fa-times text-wechat-text dark:text-white"></i>
                    </button>
                </div>

                <div class="space-y-6">
                    <!-- ËÅäÂ§©ÂØπË±°‰ø°ÊÅØ -->
                    <div>
                        <h3 class="font-medium text-wechat-text mb-3 dark:text-white">ËÅäÂ§©ÂØπË±°‰ø°ÊÅØ</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">AIÂêçÁß∞</label>
                                <input type="text" id="chatName" placeholder="Êô∫ËÉΩËÅäÂ§©Âä©Êâã" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-user-blue/20 focus:border-user-blue transition-colors duration-300 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">AIÂ§¥ÂÉèURL</label>
                                <input type="text" id="chatAvatarUrl" placeholder="ËæìÂÖ•Â§¥ÂÉèURL" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-user-blue/20 focus:border-user-blue transition-colors duration-300 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">‰Ω†ÁöÑÂ§¥ÂÉèURL</label>
                                <input type="text" id="userAvatarUrl" placeholder="ËæìÂÖ•‰Ω†ÁöÑÂ§¥ÂÉèURL" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-user-blue/20 focus:border-user-blue transition-colors duration-300 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">AI‰∫∫ËÆæÊèèËø∞ (Prompt)</label>
                                <textarea id="aiPrompt" placeholder="ËØ∑ÊèèËø∞AIÁöÑÊÄßÊ†º„ÄÅ‰∏ì‰∏öÈ¢ÜÂüü„ÄÅÂõûÁ≠îÈ£éÊ†ºÁ≠âÔºåÁî®‰∫éAIÂæÆË∞É" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-user-blue/20 focus:border-user-blue transition-colors duration-300 dark:bg-gray-700 dark:text-white dark:border-gray-600 resize-none"></textarea>
                                <p class="text-xs text-gray-500 mt-1 dark:text-gray-400">Ëøô‰∏™ÊèèËø∞Â∞Ü‰Ωú‰∏∫Á≥ªÁªüÊèêÁ§∫ÂèëÈÄÅÁªôAIÔºåÂΩ±ÂìçÂÖ∂ÂõûÁ≠îÈ£éÊ†ºÂíåË°å‰∏∫</p>
                            </div>
                        </div>
                    </div>

                    <!-- APIËÆæÁΩÆ -->
                    <div>
                        <h3 class="font-medium text-wechat-text mb-3 dark:text-white">APIËÆæÁΩÆ</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">API-KEY</label>
                                <input type="password" id="apiKey" placeholder="sk-..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-user-blue/20 focus:border-user-blue transition-colors duration-300 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">APIÂü∫Á°ÄÂú∞ÂùÄ</label>
                                <input type="text" id="apiBaseUrl" placeholder="https://api.openai.com/v1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-user-blue/20 focus:border-user-blue transition-colors duration-300 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">Ê®°ÂûãÂûãÂè∑</label>
                                <input type="text" id="modelName" placeholder="gpt-3.5-turbo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-user-blue/20 focus:border-user-blue transition-colors duration-300 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                            </div>
                        </div>
                    </div>

                    <!-- ÂèÇÊï∞ËÆæÁΩÆ -->
                    <div>
                        <h3 class="font-medium text-wechat-text mb-3 dark:text-white">ÂØπËØùÂèÇÊï∞</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">ËæìÂá∫Token‰∏äÈôê</label>
                                <input type="number" id="maxTokens" placeholder="2048" min="100" max="4096" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-user-blue/20 focus:border-user-blue transition-colors duration-300 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">Temperature (0.0-2.0)</label>
                                <input type="number" id="temperature" placeholder="0.7" step="0.1" min="0" max="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-user-blue/20 focus:border-user-blue transition-colors duration-300 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                            </div>
                        </div>
                    </div>

                    <!-- ÂØπËØùÁÆ°ÁêÜ -->
                    <div>
                        <h3 class="font-medium text-wechat-text mb-3 dark:text-white">ÂØπËØùÁÆ°ÁêÜ</h3>
                        <div class="space-y-3">
                            <button id="resetConversation" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition-colors font-medium">
                                <i class="fa fa-trash mr-2"></i>ÈáçÁΩÆÂØπËØùÂéÜÂè≤
                            </button>
                            <button id="exportConversation" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition-colors font-medium">
                                <i class="fa fa-download mr-2"></i>ÂØºÂá∫ÂØπËØù‰∏∫JSON
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2 dark:text-gray-400">
                            <i class="fa fa-info-circle mr-1"></i>ÂØπËØùÂéÜÂè≤Ëá™Âä®‰øùÂ≠òÂú®Êú¨Âú∞Ôºå‰∏ç‰ºö‰∏ä‰º†Âà∞ÊúçÂä°Âô®
                        </p>
                    </div>

                    <!-- ‰øùÂ≠òÊåâÈíÆ -->
                    <button id="saveSettings" class="w-full bg-user-blue text-white py-3 rounded-lg hover:bg-blue-500 transition-colors font-medium">
                        ‰øùÂ≠òËÆæÁΩÆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Ë°®ÊÉÖÁ¨¶Âè∑Êï∞ÊçÆ
        const emojis = [
            'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá', 'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞',
            'üòò', 'üòó', 'üòô', 'üòö', 'üòã', 'üòõ', 'üòù', 'üòú', 'ü§™', 'üòé', 'ü§ì', 'üßê', 'üòè', 'üò£', 'üò•', 'üòÆ',
            'üëã', 'üëç', 'üëé', 'üëå', 'üëä', '‚úä', 'ü§õ', 'ü§ú', 'ü§û', '‚úåÔ∏è', 'ü§ü', 'ü§ò', 'üëà', 'üëâ', 'üëÜ', 'üëá',
            'üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'ü¶ù', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üêΩ', 'üê∏',
            'üçé', 'üçê', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'üçí', 'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù', 'üçÖ', 'ü•ë',
            '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ'
        ];

        // ÂÖ®Â±ÄÂèòÈáè
        let conversationHistory = [];
        let isLoading = false;

        // DOMÂÖÉÁ¥†
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPanel = document.getElementById('emojiPanel');
        const emojiContent = document.getElementById('emojiContent');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const messageList = document.getElementById('messageList');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettings = document.getElementById('closeSettings');
        const saveSettings = document.getElementById('saveSettings');
        const themeToggle = document.getElementById('themeToggle');
        const chatTitle = document.getElementById('chatTitle');
        const chatAvatar = document.getElementById('chatAvatar');
        const resetConversationBtn = document.getElementById('resetConversation');
        const exportConversationBtn = document.getElementById('exportConversation');

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            renderEmojis();
            loadSettings();
            loadConversationHistory();
            setupEventListeners();
            updateSendButton();
        });

        // Ê∏≤ÊüìË°®ÊÉÖ - ‰øÆÂ§çÁïôÁôΩÈóÆÈ¢ò
        function renderEmojis() {
            emojiContent.innerHTML = '';
            
            // ÂàõÂª∫Ë°®ÊÉÖÂÆπÂô®Ôºå‰ΩøÁî®gridÂ∏ÉÂ±ÄÈÅøÂÖçÁïôÁôΩ
            const emojiGrid = document.createElement('div');
            emojiGrid.className = 'grid grid-cols-8 gap-2';
            
            emojis.forEach(emoji => {
                const emojiBtn = document.createElement('button');
                emojiBtn.textContent = emoji;
                emojiBtn.className = 'w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-200 transition-colors text-xl dark:hover:bg-gray-700';
                emojiBtn.style.minWidth = '40px';
                emojiBtn.style.minHeight = '40px';
                emojiBtn.onclick = () => insertEmoji(emoji);
                emojiGrid.appendChild(emojiBtn);
            });
            
            emojiContent.appendChild(emojiGrid);
        }

        // ÊèíÂÖ•Ë°®ÊÉÖ
        function insertEmoji(emoji) {
            const cursorPos = messageInput.selectionStart;
            const text = messageInput.value;
            const newText = text.substring(0, cursorPos) + emoji + text.substring(cursorPos);
            messageInput.value = newText;
            messageInput.focus();
            messageInput.selectionStart = messageInput.selectionEnd = cursorPos + emoji.length;
            updateSendButton();
            emojiPanel.classList.add('hidden');
        }

        // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
        function setupEventListeners() {
            // Ë°®ÊÉÖÊåâÈíÆ
            emojiBtn.addEventListener('click', () => {
                emojiPanel.classList.toggle('hidden');
            });

            // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠Ë°®ÊÉÖÈù¢Êùø
            document.addEventListener('click', (e) => {
                if (!emojiBtn.contains(e.target) && !emojiPanel.contains(e.target)) {
                    emojiPanel.classList.add('hidden');
                }
            });

            // ËæìÂÖ•Ê°ÜÂèòÂåñ
            messageInput.addEventListener('input', updateSendButton);
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // ÂèëÈÄÅÊåâÈíÆ
            sendBtn.addEventListener('click', sendMessage);

            // ËÆæÁΩÆÊåâÈíÆ
            settingsBtn.addEventListener('click', () => {
                settingsModal.classList.remove('hidden');
            });

            // ÂÖ≥Èó≠ËÆæÁΩÆ
            closeSettings.addEventListener('click', () => {
                settingsModal.classList.add('hidden');
            });

            // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠ËÆæÁΩÆ
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) {
                    settingsModal.classList.add('hidden');
                }
            });

            // ‰øùÂ≠òËÆæÁΩÆ
            saveSettings.addEventListener('click', saveSettingsToLocal);

            // ‰∏ªÈ¢òÂàáÊç¢
            themeToggle.addEventListener('click', toggleTheme);

            // ÈáçÁΩÆÂØπËØù
            resetConversationBtn.addEventListener('click', resetConversation);

            // ÂØºÂá∫ÂØπËØù
            exportConversationBtn.addEventListener('click', exportConversation);
        }

        // Êõ¥Êñ∞ÂèëÈÄÅÊåâÈíÆÁä∂ÊÄÅ
        function updateSendButton() {
            sendBtn.disabled = messageInput.value.trim() === '' || isLoading;
        }

        // Ê∑ªÂä†Ê∂àÊÅØÂà∞ËÅäÂ§©ÁïåÈù¢
        function addMessage(content, isUser = false, timestamp = new Date()) {
            const messageDiv = document.createElement('div');
            // Â§ßÂπÖÂ¢ûÂä†Èó¥Ë∑ùÂà∞space-x-8ÔºåÂπ∂‰∏∫Áî®Êà∑Ê∂àÊÅØÊ∑ªÂä†È¢ùÂ§ñÁöÑÂè≥ËæπË∑ù
            messageDiv.className = `flex items-start animate-fade-in ${isUser ? 'justify-end space-x-8' : 'space-x-6'}`;
            
            const avatarClass = isUser ? 'order-2 ml-4' : 'order-1';
            const bubbleClass = isUser ? 'order-1 bg-user-blue text-white message-bubble-right pr-6' : 'order-2 bg-white message-bubble-left shadow-sm dark:bg-gray-700 dark:text-white';
            
            const avatar = document.createElement('div');
            avatar.className = `w-8 h-8 rounded-full overflow-hidden flex items-center justify-center flex-shrink-0 mt-1 ${avatarClass}`;

            // Ë∞ÉÊï¥Áî®Êà∑Â§¥ÂÉèÂ∑¶ËæπË∑ù‰∏∫20px
            if (isUser) {
                avatar.style.marginLeft = '20px';
            }
            
            const settings = getSettings();
            if (isUser && settings.userAvatarUrl) {
                avatar.style.backgroundImage = `url(${settings.userAvatarUrl})`;
                avatar.style.backgroundSize = 'cover';
                avatar.style.backgroundPosition = 'center';
                avatar.innerHTML = '';
            } else if (!isUser && settings.chatAvatarUrl) {
                avatar.style.backgroundImage = `url(${settings.chatAvatarUrl})`;
                avatar.style.backgroundSize = 'cover';
                avatar.style.backgroundPosition = 'center';
                avatar.innerHTML = '';
            } else {
                avatar.style.backgroundColor = isUser ? '#007AFF' : '#8E8E93';
                avatar.innerHTML = '<i class="fa fa-bullseye text-white text-sm"></i>';
            }
            
            const bubble = document.createElement('div');
            bubble.className = `${bubbleClass} rounded-lg px-4 py-3 max-w-[75%]`;
            
            const contentP = document.createElement('p');
            contentP.className = 'leading-relaxed break-words';
            contentP.textContent = content;
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'text-xs mt-1 flex items-center justify-end';
            
            if (isUser) {
                timeDiv.innerHTML = `<span>${timestamp.toLocaleTimeString('zh-CN', { hour12: false })}</span>
                                    <i class="fa fa-check-circle ml-1 text-white/70"></i>`;
            } else {
                timeDiv.innerHTML = `<span class="text-wechat-time dark:text-gray-400">${timestamp.toLocaleTimeString('zh-CN', { hour12: false })}</span>`;
            }
            
            bubble.appendChild(contentP);
            bubble.appendChild(timeDiv);
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(bubble);
            
            messageList.appendChild(messageDiv);
            scrollToBottom();
            
            return { messageDiv, bubble };
        }

        // Ê∑ªÂä†"ÂèëÈÄÅ‰∏≠"Âä®Áîª
        function addTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'flex items-start space-x-6 animate-fade-in';
            typingDiv.id = 'typingIndicator';
            
            const avatar = document.createElement('div');
            avatar.className = 'w-8 h-8 rounded-full overflow-hidden bg-gray-400 flex items-center justify-center flex-shrink-0 mt-1';
            
            const settings = getSettings();
            if (settings.chatAvatarUrl) {
                avatar.style.backgroundImage = `url(${settings.chatAvatarUrl})`;
                avatar.style.backgroundSize = 'cover';
                avatar.style.backgroundPosition = 'center';
                avatar.innerHTML = '';
            } else {
                avatar.innerHTML = '<i class="fa fa-bullseye text-white text-sm"></i>';
            }
            
            const bubble = document.createElement('div');
            bubble.className = 'bg-white rounded-lg px-4 py-3 message-bubble-left shadow-sm dark:bg-gray-700';
            
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'flex space-x-1';
            
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = 'w-2 h-2 bg-gray-400 rounded-full animate-typing';
                dot.style.animationDelay = `${i * 0.2}s`;
                typingIndicator.appendChild(dot);
            }
            
            bubble.appendChild(typingIndicator);
            typingDiv.appendChild(avatar);
            typingDiv.appendChild(bubble);
            
            messageList.appendChild(typingDiv);
            scrollToBottom();
            
            return typingDiv;
        }

        // ÁßªÈô§"ÂèëÈÄÅ‰∏≠"Âä®Áîª
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // ÊûÑÂª∫APIËØ∑Ê±Ç
        function buildApiRequest(userMessage) {
            const settings = getSettings();
            
            // È™åËØÅAPIËÆæÁΩÆ
            if (!settings.apiKey) {
                throw new Error('ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPI-KEY');
            }
            
            if (!settings.apiBaseUrl) {
                throw new Error('ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPIÂü∫Á°ÄÂú∞ÂùÄ');
            }
            
            // ÊûÑÂª∫Ê∂àÊÅØÊï∞ÁªÑ
            const messages = [];
            
            // Ê∑ªÂä†Á≥ªÁªüÊèêÁ§∫ÔºàAI‰∫∫ËÆæÊèèËø∞Ôºâ
            if (settings.aiPrompt) {
                messages.push({
                    role: 'system',
                    content: settings.aiPrompt
                });
            }
            
            // Ê∑ªÂä†ÂéÜÂè≤ÂØπËØù
            messages.push(...conversationHistory);
            
            // Ê∑ªÂä†ÂΩìÂâçÁî®Êà∑Ê∂àÊÅØ
            messages.push({
                role: 'user',
                content: userMessage
            });
            
            return {
                model: settings.modelName || 'gpt-3.5-turbo',
                messages: messages,
                max_tokens: parseInt(settings.maxTokens) || 2048,
                temperature: parseFloat(settings.temperature) || 0.7,
                top_p: 1,
                frequency_penalty: 0,
                presence_penalty: 0
            };
        }

        // Ë∞ÉÁî®AI API
        async function callAIApi(userMessage) {
            const settings = getSettings();
            
            try {
                const requestData = buildApiRequest(userMessage);
                const apiUrl = `${settings.apiBaseUrl}/chat/completions`;
                
                console.log('APIËØ∑Ê±Ç:', {
                    url: apiUrl,
                    model: requestData.model,
                    messages: requestData.messages.length,
                    max_tokens: requestData.max_tokens,
                    temperature: requestData.temperature
                });
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${settings.apiKey}`
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    console.error('APIÂìçÂ∫îÈîôËØØ:', data);
                    throw new Error(data.error?.message || `APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status}`);
                }
                
                console.log('APIÂìçÂ∫îÊàêÂäü:', data);
                return data.choices[0].message.content;
                
            } catch (error) {
                console.error('APIË∞ÉÁî®Â§±Ë¥•:', error);
                throw error;
            }
        }

        // ÂèëÈÄÅÊ∂àÊÅØ
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || isLoading) return;
            
            try {
                isLoading = true;
                updateSendButton();
                
                // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØÂà∞ÁïåÈù¢
                const timestamp = new Date();
                addMessage(message, true, timestamp);
                messageInput.value = '';
                
                // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØÂà∞ÂéÜÂè≤ËÆ∞ÂΩï
                conversationHistory.push({ 
                    role: 'user', 
                    content: message,
                    timestamp: timestamp.toISOString()
                });
                
                // ‰øùÂ≠òÂØπËØùÂéÜÂè≤
                saveConversationHistory();
                
                // Ê∑ªÂä†"ÂèëÈÄÅ‰∏≠"Âä®Áîª
                addTypingIndicator();
                
                try {
                    // Ë∞ÉÁî®ÁúüÂÆûAI API
                    const reply = await callAIApi(message);
                    
                    // ÁßªÈô§"ÂèëÈÄÅ‰∏≠"Âä®Áîª
                    removeTypingIndicator();
                    
                    // Ê∑ªÂä†ÂõûÂ§çÊ∂àÊÅØÂà∞ÁïåÈù¢
                    const replyTimestamp = new Date();
                    addMessage(reply, false, replyTimestamp);
                    
                    // Ê∑ªÂä†ÂõûÂ§çÊ∂àÊÅØÂà∞ÂéÜÂè≤ËÆ∞ÂΩï
                    conversationHistory.push({ 
                        role: 'assistant', 
                        content: reply,
                        timestamp: replyTimestamp.toISOString()
                    });
                    
                    // ‰øùÂ≠òÂØπËØùÂéÜÂè≤
                    saveConversationHistory();
                    
                } catch (error) {
                    // ÁßªÈô§"ÂèëÈÄÅ‰∏≠"Âä®Áîª
                    removeTypingIndicator();
                    
                    // ÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
                    const errorTimestamp = new Date();
                    addMessage(`‚ùå ${error.message}`, false, errorTimestamp);
                    
                    // Ê∑ªÂä†ÈîôËØØÊ∂àÊÅØÂà∞ÂéÜÂè≤ËÆ∞ÂΩï
                    conversationHistory.push({ 
                        role: 'error', 
                        content: error.message,
                        timestamp: errorTimestamp.toISOString()
                    });
                    
                    // ‰øùÂ≠òÂØπËØùÂéÜÂè≤
                    saveConversationHistory();
                }
                
            } finally {
                isLoading = false;
                updateSendButton();
            }
        }

        // ÊªöÂä®Âà∞Â∫ïÈÉ®
        function scrollToBottom() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // ËÆæÁΩÆÁÆ°ÁêÜ
        function getSettings() {
            const defaultSettings = {
                chatName: 'Êô∫ËÉΩËÅäÂ§©Âä©Êâã',
                chatAvatarUrl: '',
                userAvatarUrl: '',
                aiPrompt: '',
                apiKey: '',
                apiBaseUrl: 'https://api.openai.com/v1',
                modelName: 'gpt-3.5-turbo',
                maxTokens: '2048',
                temperature: '0.7',
                contextWindow: '10',
                theme: 'light'
            };
            
            const saved = localStorage.getItem('chatSettings');
            return saved ? { ...defaultSettings, ...JSON.parse(saved) } : defaultSettings;
        }

        function saveSettingsToLocal() {
            const settings = {
                chatName: document.getElementById('chatName').value || 'Êô∫ËÉΩËÅäÂ§©Âä©Êâã',
                chatAvatarUrl: document.getElementById('chatAvatarUrl').value || '',
                userAvatarUrl: document.getElementById('userAvatarUrl').value || '',
                aiPrompt: document.getElementById('aiPrompt').value || '',
                apiKey: document.getElementById('apiKey').value || '',
                apiBaseUrl: document.getElementById('apiBaseUrl').value || 'https://api.openai.com/v1',
                modelName: document.getElementById('modelName').value || 'gpt-3.5-turbo',
                maxTokens: document.getElementById('maxTokens').value || '2048',
                temperature: document.getElementById('temperature').value || '0.7',
                contextWindow: document.getElementById('contextWindow')?.value || '10',
                theme: getSettings().theme
            };
            
            localStorage.setItem('chatSettings', JSON.stringify(settings));
            
            // Êõ¥Êñ∞ÁïåÈù¢
            chatTitle.textContent = settings.chatName;
            if (settings.chatAvatarUrl) {
                chatAvatar.style.backgroundImage = `url(${settings.chatAvatarUrl})`;
                chatAvatar.style.backgroundSize = 'cover';
                chatAvatar.style.backgroundPosition = 'center';
                chatAvatar.innerHTML = '';
            }
            
            // ÊòæÁ§∫‰øùÂ≠òÊàêÂäüÊèêÁ§∫
            const originalText = saveSettings.textContent;
            saveSettings.textContent = '‰øùÂ≠òÊàêÂäüÔºÅ';
            saveSettings.classList.add('bg-green-500');
            
            setTimeout(() => {
                saveSettings.textContent = originalText;
                saveSettings.classList.remove('bg-green-500');
                settingsModal.classList.add('hidden');
            }, 1500);
        }

        function loadSettings() {
            const settings = getSettings();
            
            document.getElementById('chatName').value = settings.chatName || 'Êô∫ËÉΩËÅäÂ§©Âä©Êâã';
            document.getElementById('chatAvatarUrl').value = settings.chatAvatarUrl || '';
            document.getElementById('userAvatarUrl').value = settings.userAvatarUrl || '';
            document.getElementById('aiPrompt').value = settings.aiPrompt || '';
            document.getElementById('apiKey').value = settings.apiKey || '';
            document.getElementById('apiBaseUrl').value = settings.apiBaseUrl || 'https://api.openai.com/v1';
            document.getElementById('modelName').value = settings.modelName || 'gpt-3.5-turbo';
            document.getElementById('maxTokens').value = settings.maxTokens || '2048';
            document.getElementById('temperature').value = settings.temperature || '0.7';
            
            // Êõ¥Êñ∞ÁïåÈù¢
            chatTitle.textContent = settings.chatName;
            if (settings.chatAvatarUrl) {
                chatAvatar.style.backgroundImage = `url(${settings.chatAvatarUrl})`;
                chatAvatar.style.backgroundSize = 'cover';
                chatAvatar.style.backgroundPosition = 'center';
                chatAvatar.innerHTML = '';
            }
            
            // Âä†ËΩΩ‰∏ªÈ¢ò
            if (settings.theme === 'dark') {
                document.documentElement.classList.add('dark');
            }
        }

        // ‰∏ªÈ¢òÂàáÊç¢
        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            const settings = getSettings();
            settings.theme = isDark ? 'dark' : 'light';
            localStorage.setItem('chatSettings', JSON.stringify(settings));
        }

        // ÂØπËØùÂéÜÂè≤ÁÆ°ÁêÜ
        function saveConversationHistory() {
            localStorage.setItem('conversationHistory', JSON.stringify(conversationHistory));
        }

        function loadConversationHistory() {
            const savedHistory = localStorage.getItem('conversationHistory');
            if (savedHistory) {
                conversationHistory = JSON.parse(savedHistory);
                // ÈáçÊñ∞Ê∏≤ÊüìÂØπËØùÂéÜÂè≤
                renderConversationHistory();
            }
        }

        function renderConversationHistory() {
            messageList.innerHTML = '';
            conversationHistory.forEach(msg => {
                const timestamp = new Date(msg.timestamp);
                addMessage(msg.content, msg.role === 'user', timestamp);
            });
        }

        // ÈáçÁΩÆÂØπËØùÂéÜÂè≤
        function resetConversation() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂØπËØùÂéÜÂè≤ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ')) {
                conversationHistory = [];
                localStorage.removeItem('conversationHistory');
                messageList.innerHTML = '';
                
                // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
                const originalText = resetConversationBtn.textContent;
                resetConversationBtn.textContent = '‚úÖ ÂØπËØùÂ∑≤ÈáçÁΩÆ';
                resetConversationBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                resetConversationBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                
                setTimeout(() => {
                    resetConversationBtn.innerHTML = '<i class="fa fa-trash mr-2"></i>ÈáçÁΩÆÂØπËØùÂéÜÂè≤';
                    resetConversationBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                    resetConversationBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                }, 2000);
            }
        }

        // ÂØºÂá∫ÂØπËØù‰∏∫JSON
        function exportConversation() {
            if (conversationHistory.length === 0) {
                alert('Ê≤°ÊúâÂØπËØùÂéÜÂè≤ÂèØÂØºÂá∫');
                return;
            }
            
            // ÂàõÂª∫ÂØºÂá∫Êï∞ÊçÆ
            const exportData = {
                conversation: conversationHistory,
                exportDate: new Date().toISOString(),
                chatSettings: {
                    chatName: getSettings().chatName,
                    aiPrompt: getSettings().aiPrompt
                }
            };
            
            // ÂàõÂª∫JSONÊñá‰ª∂
            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat_conversation_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            
            // Ê∏ÖÁêÜ
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
            const originalText = exportConversationBtn.textContent;
            exportConversationBtn.textContent = '‚úÖ ÂØºÂá∫ÊàêÂäü';
            exportConversationBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
            exportConversationBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            
            setTimeout(() => {
                exportConversationBtn.innerHTML = '<i class="fa fa-download mr-2"></i>ÂØºÂá∫ÂØπËØù‰∏∫JSON';
                exportConversationBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                exportConversationBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            }, 2000);
        }

        // ÂÆöÊúü‰øùÂ≠òÂØπËØùÂéÜÂè≤
        setInterval(() => {
            if (conversationHistory.length > 0) {
                saveConversationHistory();
            }
        }, 30000);

        // È°µÈù¢Á¶ªÂºÄÊó∂‰øùÂ≠ò
        window.addEventListener('beforeunload', () => {
            saveConversationHistory();
        });
    </script>
</body>
</html>
