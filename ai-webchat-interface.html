<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'user-blue': '#007AFF',
                        'wechat-gray': '#F2F2F2',
                        'wechat-text': '#1D1D1F',
                        'wechat-time': '#86909C'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'typing': 'typing 1.4s infinite both'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        typing: {
                            '0%, 100%': { opacity: '0.2' },
                            '50%': { opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide {
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .message-bubble-left {
                border-radius: 18px 18px 18px 4px;
            }
            .message-bubble-right {
                border-radius: 18px 18px 4px 18px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden transition-colors duration-300 dark:bg-gray-900">
    <!-- ä¸»å®¹å™¨ -->
    <div class="flex flex-col h-full">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <header class="bg-white shadow-sm z-10 transition-colors duration-300 dark:bg-gray-800">
            <div class="flex items-center justify-between px-4 py-3">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 rounded-full overflow-hidden bg-gray-400 flex items-center justify-center" id="chatAvatar">
                            <i class="fa fa-bullseye text-white text-lg"></i>
                        </div>
                        <div>
                            <h1 class="text-lg font-semibold text-wechat-text dark:text-white" id="chatTitle">æ™ºèƒ½èŠå¤©åŠ©æ‰‹</h1>
                            <p class="text-xs text-wechat-time dark:text-gray-400" id="onlineStatus">ğŸŸ¢ åœ¨çº¿</p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="themeToggle" class="p-2 rounded-full hover:bg-gray-200 transition-colors dark:hover:bg-gray-700">
                        <i class="fa fa-moon-o text-wechat-text dark:text-white dark:hidden"></i>
                        <i class="fa fa-sun-o text-white hidden dark:inline"></i>
                    </button>
                    <button id="settingsBtn" class="p-2 rounded-full hover:bg-gray-200 transition-colors dark:hover:bg-gray-700">
                        <i class="fa fa-cog text-wechat-text dark:text-white"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- èŠå¤©åŒºåŸŸ -->
        <main class="flex-1 overflow-y-auto scrollbar-hide p-4 transition-colors duration-300 dark:bg-gray-900" id="chatContainer">
            <div class="max-w-4xl mx-auto space-y-6" id="messageList">
                <!-- åˆå§‹ä¸ºç©ºï¼Œæ²¡æœ‰æ¬¢è¿æ¶ˆæ¯å’Œé¦–å¥å‘è¨€ -->
            </div>
        </main>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <footer class="bg-white border-t border-gray-200 p-3 transition-colors duration-300 dark:bg-gray-800 dark:border-gray-700">
            <div class="max-w-4xl mx-auto">
                <div class="flex items-center space-x-2">
                    <button id="emojiBtn" class="p-2 rounded-full hover:bg-gray-200 transition-colors dark:hover:bg-gray-700">
                        <i class="fa fa-smile-o text-wechat-text dark:text-white"></i>
                    </button>
                    <div class="flex-1 relative">
                        <textarea 
                            id="messageInput" 
                            placeholder="è¯·è¾“å…¥æ¶ˆæ¯..." 
                            class="w-full px-4 py-2 bg-gray-100 rounded-full focus:outline-none focus:ring-2 focus:ring-user-blue/20 resize-none h-12 transition-colors duration-300 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400"
                            rows="1"
                        ></textarea>
                    </div>
                    <button id="sendBtn" class="w-10 h-10 rounded-full bg-user-blue text-white flex items-center justify-center hover:bg-blue-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fa fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </footer>
    </div>

    <!-- è¡¨æƒ…é¢æ¿ -->
    <div id="emojiPanel" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-white rounded-2xl shadow-2xl w-[90%] max-w-md z-50 hidden transition-colors duration-300 dark:bg-gray-800">
        <div class="p-4">
            <div class="emoji-content h-auto max-h-48 overflow-y-auto scrollbar-hide" id="emojiContent">
                <!-- è¡¨æƒ…å†…å®¹ -->
            </div>
        </div>
    </div>

    <!-- è®¾ç½®é¢æ¿ -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 dark:bg-black/70">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[80vh] overflow-y-auto scrollbar-hide transition-colors duration-300 dark:bg-gray-800">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-wechat-text dark:text-white">èŠå¤©è®¾ç½®</h2>
                    <button id="closeSettings" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <i class="fa fa-times text-wechat-text dark:text-white"></i>
                    </button>
                </div>

                <div class="space-y-6">
                    <!-- èŠå¤©å¯¹è±¡ä¿¡æ¯ -->
                    <div>
                        <h3 class="font-medium text-wechat-text mb-3 dark:text-white">èŠå¤©å¯¹è±¡ä¿¡æ¯</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">AIåç§°</label>
                                <input type="text" id="chatName" placeholder="æ™ºèƒ½èŠå¤©åŠ©æ‰‹" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-user-blue/20 focus:border-user-blue transition-colors duration-300 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">AIå¤´åƒURL</label>
                                <input type="text" id="chatAvatarUrl" placeholder="è¾“å…¥å¤´åƒURL" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-user-blue/20 focus:border-user-blue transition-colors duration-300 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">ä½ çš„å¤´åƒURL</label>
                                <input type="text" id="userAvatarUrl" placeholder="è¾“å…¥ä½ çš„å¤´åƒURL" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-user-blue/20 focus:border-user-blue transition-colors duration-300 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">AIäººè®¾æè¿° (Prompt)</label>
                                <textarea id="aiPrompt" placeholder="è¯·æè¿°AIçš„æ€§æ ¼ã€ä¸“ä¸šé¢†åŸŸã€å›ç­”é£æ ¼ç­‰ï¼Œç”¨äºAIå¾®è°ƒ" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-user-blue/20 focus:border-user-blue transition-colors duration-300 dark:bg-gray-700 dark:text-white dark:border-gray-600 resize-none"></textarea>
                                <p class="text-xs text-gray-500 mt-1 dark:text-gray-400">è¿™ä¸ªæè¿°å°†ä½œä¸ºç³»ç»Ÿæç¤ºå‘é€ç»™AIï¼Œå½±å“å…¶å›ç­”é£æ ¼å’Œè¡Œä¸º</p>
                            </div>
                        </div>
                    </div>

                    <!-- APIè®¾ç½® -->
                    <div>
                        <h3 class="font-medium text-wechat-text mb-3 dark:text-white">APIè®¾ç½®</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">API-KEY</label>
                                <input type="password" id="apiKey" placeholder="sk-..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-user-blue/20 focus:border-user-blue transition-colors duration-300 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">APIåŸºç¡€åœ°å€</label>
                                <input type="text" id="apiBaseUrl" placeholder="https://api.openai.com/v1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-user-blue/20 focus:border-user-blue transition-colors duration-300 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">æ¨¡å‹å‹å·</label>
                                <input type="text" id="modelName" placeholder="gpt-3.5-turbo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-user-blue/20 focus:border-user-blue transition-colors duration-300 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                            </div>
                        </div>
                    </div>

                    <!-- å‚æ•°è®¾ç½® -->
                    <div>
                        <h3 class="font-medium text-wechat-text mb-3 dark:text-white">å¯¹è¯å‚æ•°</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">è¾“å‡ºTokenä¸Šé™</label>
                                <input type="number" id="maxTokens" placeholder="2048" min="100" max="4096" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-user-blue/20 focus:border-user-blue transition-colors duration-300 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">Temperature (0.0-2.0)</label>
                                <input type="number" id="temperature" placeholder="0.7" step="0.1" min="0" max="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-user-blue/20 focus:border-user-blue transition-colors duration-300 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                            </div>
                        </div>
                    </div>

                    <!-- å¯¹è¯ç®¡ç† -->
                    <div>
                        <h3 class="font-medium text-wechat-text mb-3 dark:text-white">å¯¹è¯ç®¡ç†</h3>
                        <div class="space-y-3">
                            <button id="resetConversation" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition-colors font-medium">
                                <i class="fa fa-trash mr-2"></i>é‡ç½®å¯¹è¯å†å²
                            </button>
                            <button id="exportConversation" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition-colors font-medium">
                                <i class="fa fa-download mr-2"></i>å¯¼å‡ºå¯¹è¯ä¸ºJSON
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2 dark:text-gray-400">
                            <i class="fa fa-info-circle mr-1"></i>å¯¹è¯å†å²è‡ªåŠ¨ä¿å­˜åœ¨æœ¬åœ°ï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨
                        </p>
                    </div>

                    <!-- ä¿å­˜æŒ‰é’® -->
                    <button id="saveSettings" class="w-full bg-user-blue text-white py-3 rounded-lg hover:bg-blue-500 transition-colors font-medium">
                        ä¿å­˜è®¾ç½®
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è¡¨æƒ…ç¬¦å·æ•°æ®
        const emojis = [
            'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°',
            'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ¤“', 'ğŸ§', 'ğŸ˜', 'ğŸ˜£', 'ğŸ˜¥', 'ğŸ˜®',
            'ğŸ‘‹', 'ğŸ‘', 'ğŸ‘', 'ğŸ‘Œ', 'ğŸ‘Š', 'âœŠ', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†', 'ğŸ‘‡',
            'ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ¦', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ½', 'ğŸ¸',
            'ğŸ', 'ğŸ', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ‰', 'ğŸ‡', 'ğŸ“', 'ğŸ’', 'ğŸ‘', 'ğŸ¥­', 'ğŸ', 'ğŸ¥¥', 'ğŸ¥', 'ğŸ…', 'ğŸ¥‘',
            'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–'
        ];

        // å…¨å±€å˜é‡
        let conversationHistory = [];
        let isLoading = false;

        // DOMå…ƒç´ 
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPanel = document.getElementById('emojiPanel');
        const emojiContent = document.getElementById('emojiContent');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const messageList = document.getElementById('messageList');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettings = document.getElementById('closeSettings');
        const saveSettings = document.getElementById('saveSettings');
        const themeToggle = document.getElementById('themeToggle');
        const chatTitle = document.getElementById('chatTitle');
        const chatAvatar = document.getElementById('chatAvatar');
        const resetConversationBtn = document.getElementById('resetConversation');
        const exportConversationBtn = document.getElementById('exportConversation');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            renderEmojis();
            loadSettings();
            loadConversationHistory();
            setupEventListeners();
            updateSendButton();
        });

        // æ¸²æŸ“è¡¨æƒ… - ä¿®å¤ç•™ç™½é—®é¢˜
        function renderEmojis() {
            emojiContent.innerHTML = '';
            
            // åˆ›å»ºè¡¨æƒ…å®¹å™¨ï¼Œä½¿ç”¨gridå¸ƒå±€é¿å…ç•™ç™½
            const emojiGrid = document.createElement('div');
            emojiGrid.className = 'grid grid-cols-8 gap-2';
            
            emojis.forEach(emoji => {
                const emojiBtn = document.createElement('button');
                emojiBtn.textContent = emoji;
                emojiBtn.className = 'w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-200 transition-colors text-xl dark:hover:bg-gray-700';
                emojiBtn.style.minWidth = '40px';
                emojiBtn.style.minHeight = '40px';
                emojiBtn.onclick = () => insertEmoji(emoji);
                emojiGrid.appendChild(emojiBtn);
            });
            
            emojiContent.appendChild(emojiGrid);
        }

        // æ’å…¥è¡¨æƒ…
        function insertEmoji(emoji) {
            const cursorPos = messageInput.selectionStart;
            const text = messageInput.value;
            const newText = text.substring(0, cursorPos) + emoji + text.substring(cursorPos);
            messageInput.value = newText;
            messageInput.focus();
            messageInput.selectionStart = messageInput.selectionEnd = cursorPos + emoji.length;
            updateSendButton();
            emojiPanel.classList.add('hidden');
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // è¡¨æƒ…æŒ‰é’®
            emojiBtn.addEventListener('click', () => {
                emojiPanel.classList.toggle('hidden');
            });

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­è¡¨æƒ…é¢æ¿
            document.addEventListener('click', (e) => {
                if (!emojiBtn.contains(e.target) && !emojiPanel.contains(e.target)) {
                    emojiPanel.classList.add('hidden');
                }
            });

            // è¾“å…¥æ¡†å˜åŒ–
            messageInput.addEventListener('input', updateSendButton);
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // å‘é€æŒ‰é’®
            sendBtn.addEventListener('click', sendMessage);

            // è®¾ç½®æŒ‰é’®
            settingsBtn.addEventListener('click', () => {
                settingsModal.classList.remove('hidden');
            });

            // å…³é—­è®¾ç½®
            closeSettings.addEventListener('click', () => {
                settingsModal.classList.add('hidden');
            });

            // ç‚¹å‡»èƒŒæ™¯å…³é—­è®¾ç½®
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) {
                    settingsModal.classList.add('hidden');
                }
            });

            // ä¿å­˜è®¾ç½®
            saveSettings.addEventListener('click', saveSettingsToLocal);

            // ä¸»é¢˜åˆ‡æ¢
            themeToggle.addEventListener('click', toggleTheme);

            // é‡ç½®å¯¹è¯
            resetConversationBtn.addEventListener('click', resetConversation);

            // å¯¼å‡ºå¯¹è¯
            exportConversationBtn.addEventListener('click', exportConversation);
        }

        // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
        function updateSendButton() {
            sendBtn.disabled = messageInput.value.trim() === '' || isLoading;
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        function addMessage(content, isUser = false, timestamp = new Date()) {
            const messageDiv = document.createElement('div');
            // å¤§å¹…å¢åŠ é—´è·åˆ°space-x-8ï¼Œå¹¶ä¸ºç”¨æˆ·æ¶ˆæ¯æ·»åŠ é¢å¤–çš„å³è¾¹è·
            messageDiv.className = `flex items-start animate-fade-in ${isUser ? 'justify-end space-x-8' : 'space-x-6'}`;
            
            const avatarClass = isUser ? 'order-2 ml-4' : 'order-1';
            const bubbleClass = isUser ? 'order-1 bg-user-blue text-white message-bubble-right pr-6' : 'order-2 bg-white message-bubble-left shadow-sm dark:bg-gray-700 dark:text-white';
            
            const avatar = document.createElement('div');
            avatar.className = `w-8 h-8 rounded-full overflow-hidden flex items-center justify-center flex-shrink-0 mt-1 ${avatarClass}`;

            // è°ƒæ•´ç”¨æˆ·å¤´åƒå·¦è¾¹è·ä¸º20px
            if (isUser) {
                avatar.style.marginLeft = '20px';
            }
            
            const settings = getSettings();
            if (isUser && settings.userAvatarUrl) {
                avatar.style.backgroundImage = `url(${settings.userAvatarUrl})`;
                avatar.style.backgroundSize = 'cover';
                avatar.style.backgroundPosition = 'center';
                avatar.innerHTML = '';
            } else if (!isUser && settings.chatAvatarUrl) {
                avatar.style.backgroundImage = `url(${settings.chatAvatarUrl})`;
                avatar.style.backgroundSize = 'cover';
                avatar.style.backgroundPosition = 'center';
                avatar.innerHTML = '';
            } else {
                avatar.style.backgroundColor = isUser ? '#007AFF' : '#8E8E93';
                avatar.innerHTML = '<i class="fa fa-bullseye text-white text-sm"></i>';
            }
            
            const bubble = document.createElement('div');
            bubble.className = `${bubbleClass} rounded-lg px-4 py-3 max-w-[75%]`;
            
            const contentP = document.createElement('p');
            contentP.className = 'leading-relaxed break-words';
            contentP.textContent = content;
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'text-xs mt-1 flex items-center justify-end';
            
            if (isUser) {
                timeDiv.innerHTML = `<span>${timestamp.toLocaleTimeString('zh-CN', { hour12: false })}</span>
                                    <i class="fa fa-check-circle ml-1 text-white/70"></i>`;
            } else {
                timeDiv.innerHTML = `<span class="text-wechat-time dark:text-gray-400">${timestamp.toLocaleTimeString('zh-CN', { hour12: false })}</span>`;
            }
            
            bubble.appendChild(contentP);
            bubble.appendChild(timeDiv);
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(bubble);
            
            messageList.appendChild(messageDiv);
            scrollToBottom();
            
            return { messageDiv, bubble };
        }

        // æ·»åŠ "å‘é€ä¸­"åŠ¨ç”»
        function addTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'flex items-start space-x-6 animate-fade-in';
            typingDiv.id = 'typingIndicator';
            
            const avatar = document.createElement('div');
            avatar.className = 'w-8 h-8 rounded-full overflow-hidden bg-gray-400 flex items-center justify-center flex-shrink-0 mt-1';
            
            const settings = getSettings();
            if (settings.chatAvatarUrl) {
                avatar.style.backgroundImage = `url(${settings.chatAvatarUrl})`;
                avatar.style.backgroundSize = 'cover';
                avatar.style.backgroundPosition = 'center';
                avatar.innerHTML = '';
            } else {
                avatar.innerHTML = '<i class="fa fa-bullseye text-white text-sm"></i>';
            }
            
            const bubble = document.createElement('div');
            bubble.className = 'bg-white rounded-lg px-4 py-3 message-bubble-left shadow-sm dark:bg-gray-700';
            
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'flex space-x-1';
            
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = 'w-2 h-2 bg-gray-400 rounded-full animate-typing';
                dot.style.animationDelay = `${i * 0.2}s`;
                typingIndicator.appendChild(dot);
            }
            
            bubble.appendChild(typingIndicator);
            typingDiv.appendChild(avatar);
            typingDiv.appendChild(bubble);
            
            messageList.appendChild(typingDiv);
            scrollToBottom();
            
            return typingDiv;
        }

        // ç§»é™¤"å‘é€ä¸­"åŠ¨ç”»
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // æ„å»ºAPIè¯·æ±‚
        function buildApiRequest(userMessage) {
            const settings = getSettings();
            
            // éªŒè¯APIè®¾ç½®
            if (!settings.apiKey) {
                throw new Error('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®API-KEY');
            }
            
            if (!settings.apiBaseUrl) {
                throw new Error('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®APIåŸºç¡€åœ°å€');
            }
            
            // æ„å»ºæ¶ˆæ¯æ•°ç»„
            const messages = [];
            
            // æ·»åŠ ç³»ç»Ÿæç¤ºï¼ˆAIäººè®¾æè¿°ï¼‰
            if (settings.aiPrompt) {
                messages.push({
                    role: 'system',
                    content: settings.aiPrompt
                });
            }
            
            // æ·»åŠ å†å²å¯¹è¯
            messages.push(...conversationHistory);
            
            // æ·»åŠ å½“å‰ç”¨æˆ·æ¶ˆæ¯
            messages.push({
                role: 'user',
                content: userMessage
            });
            
            return {
                model: settings.modelName || 'gpt-3.5-turbo',
                messages: messages,
                max_tokens: parseInt(settings.maxTokens) || 2048,
                temperature: parseFloat(settings.temperature) || 0.7,
                top_p: 1,
                frequency_penalty: 0,
                presence_penalty: 0
            };
        }

        // è°ƒç”¨AI API
        async function callAIApi(userMessage) {
            const settings = getSettings();
            
            try {
                const requestData = buildApiRequest(userMessage);
                const apiUrl = `${settings.apiBaseUrl}/chat/completions`;
                
                console.log('APIè¯·æ±‚:', {
                    url: apiUrl,
                    model: requestData.model,
                    messages: requestData.messages.length,
                    max_tokens: requestData.max_tokens,
                    temperature: requestData.temperature
                });
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${settings.apiKey}`
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    console.error('APIå“åº”é”™è¯¯:', data);
                    throw new Error(data.error?.message || `APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                }
                
                console.log('APIå“åº”æˆåŠŸ:', data);
                return data.choices[0].message.content;
                
            } catch (error) {
                console.error('APIè°ƒç”¨å¤±è´¥:', error);
                throw error;
            }
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || isLoading) return;
            
            try {
                isLoading = true;
                updateSendButton();
                
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
                const timestamp = new Date();
                addMessage(message, true, timestamp);
                messageInput.value = '';
                
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å†å²è®°å½•
                conversationHistory.push({ 
                    role: 'user', 
                    content: message,
                    timestamp: timestamp.toISOString()
                });
                
                // ä¿å­˜å¯¹è¯å†å²
                saveConversationHistory();
                
                // æ·»åŠ "å‘é€ä¸­"åŠ¨ç”»
                addTypingIndicator();
                
                try {
                    // è°ƒç”¨çœŸå®AI API
                    const reply = await callAIApi(message);
                    
                    // ç§»é™¤"å‘é€ä¸­"åŠ¨ç”»
                    removeTypingIndicator();
                    
                    // æ·»åŠ å›å¤æ¶ˆæ¯åˆ°ç•Œé¢
                    const replyTimestamp = new Date();
                    addMessage(reply, false, replyTimestamp);
                    
                    // æ·»åŠ å›å¤æ¶ˆæ¯åˆ°å†å²è®°å½•
                    conversationHistory.push({ 
                        role: 'assistant', 
                        content: reply,
                        timestamp: replyTimestamp.toISOString()
                    });
                    
                    // ä¿å­˜å¯¹è¯å†å²
                    saveConversationHistory();
                    
                } catch (error) {
                    // ç§»é™¤"å‘é€ä¸­"åŠ¨ç”»
                    removeTypingIndicator();
                    
                    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                    const errorTimestamp = new Date();
                    addMessage(`âŒ ${error.message}`, false, errorTimestamp);
                    
                    // æ·»åŠ é”™è¯¯æ¶ˆæ¯åˆ°å†å²è®°å½•
                    conversationHistory.push({ 
                        role: 'error', 
                        content: error.message,
                        timestamp: errorTimestamp.toISOString()
                    });
                    
                    // ä¿å­˜å¯¹è¯å†å²
                    saveConversationHistory();
                }
                
            } finally {
                isLoading = false;
                updateSendButton();
            }
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // è®¾ç½®ç®¡ç†
        function getSettings() {
            const defaultSettings = {
                chatName: 'æ™ºèƒ½èŠå¤©åŠ©æ‰‹',
                chatAvatarUrl: '',
                userAvatarUrl: '',
                aiPrompt: '',
                apiKey: '',
                apiBaseUrl: 'https://api.openai.com/v1',
                modelName: 'gpt-3.5-turbo',
                maxTokens: '2048',
                temperature: '0.7',
                contextWindow: '10',
                theme: 'light'
            };
            
            const saved = localStorage.getItem('chatSettings');
            return saved ? { ...defaultSettings, ...JSON.parse(saved) } : defaultSettings;
        }

        function saveSettingsToLocal() {
            const settings = {
                chatName: document.getElementById('chatName').value || 'æ™ºèƒ½èŠå¤©åŠ©æ‰‹',
                chatAvatarUrl: document.getElementById('chatAvatarUrl').value || '',
                userAvatarUrl: document.getElementById('userAvatarUrl').value || '',
                aiPrompt: document.getElementById('aiPrompt').value || '',
                apiKey: document.getElementById('apiKey').value || '',
                apiBaseUrl: document.getElementById('apiBaseUrl').value || 'https://api.openai.com/v1',
                modelName: document.getElementById('modelName').value || 'gpt-3.5-turbo',
                maxTokens: document.getElementById('maxTokens').value || '2048',
                temperature: document.getElementById('temperature').value || '0.7',
                contextWindow: document.getElementById('contextWindow')?.value || '10',
                theme: getSettings().theme
            };
            
            localStorage.setItem('chatSettings', JSON.stringify(settings));
            
            // æ›´æ–°ç•Œé¢
            chatTitle.textContent = settings.chatName;
            if (settings.chatAvatarUrl) {
                chatAvatar.style.backgroundImage = `url(${settings.chatAvatarUrl})`;
                chatAvatar.style.backgroundSize = 'cover';
                chatAvatar.style.backgroundPosition = 'center';
                chatAvatar.innerHTML = '';
            }
            
            // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
            const originalText = saveSettings.textContent;
            saveSettings.textContent = 'ä¿å­˜æˆåŠŸï¼';
            saveSettings.classList.add('bg-green-500');
            
            setTimeout(() => {
                saveSettings.textContent = originalText;
                saveSettings.classList.remove('bg-green-500');
                settingsModal.classList.add('hidden');
            }, 1500);
        }

        function loadSettings() {
            const settings = getSettings();
            
            document.getElementById('chatName').value = settings.chatName || 'æ™ºèƒ½èŠå¤©åŠ©æ‰‹';
            document.getElementById('chatAvatarUrl').value = settings.chatAvatarUrl || '';
            document.getElementById('userAvatarUrl').value = settings.userAvatarUrl || '';
            document.getElementById('aiPrompt').value = settings.aiPrompt || '';
            document.getElementById('apiKey').value = settings.apiKey || '';
            document.getElementById('apiBaseUrl').value = settings.apiBaseUrl || 'https://api.openai.com/v1';
            document.getElementById('modelName').value = settings.modelName || 'gpt-3.5-turbo';
            document.getElementById('maxTokens').value = settings.maxTokens || '2048';
            document.getElementById('temperature').value = settings.temperature || '0.7';
            
            // æ›´æ–°ç•Œé¢
            chatTitle.textContent = settings.chatName;
            if (settings.chatAvatarUrl) {
                chatAvatar.style.backgroundImage = `url(${settings.chatAvatarUrl})`;
                chatAvatar.style.backgroundSize = 'cover';
                chatAvatar.style.backgroundPosition = 'center';
                chatAvatar.innerHTML = '';
            }
            
            // åŠ è½½ä¸»é¢˜
            if (settings.theme === 'dark') {
                document.documentElement.classList.add('dark');
            }
        }

        // ä¸»é¢˜åˆ‡æ¢
        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            const settings = getSettings();
            settings.theme = isDark ? 'dark' : 'light';
            localStorage.setItem('chatSettings', JSON.stringify(settings));
        }

        // å¯¹è¯å†å²ç®¡ç†
        function saveConversationHistory() {
            localStorage.setItem('conversationHistory', JSON.stringify(conversationHistory));
        }

        function loadConversationHistory() {
            const savedHistory = localStorage.getItem('conversationHistory');
            if (savedHistory) {
                conversationHistory = JSON.parse(savedHistory);
                // é‡æ–°æ¸²æŸ“å¯¹è¯å†å²
                renderConversationHistory();
            }
        }

        function renderConversationHistory() {
            messageList.innerHTML = '';
            conversationHistory.forEach(msg => {
                const timestamp = new Date(msg.timestamp);
                addMessage(msg.content, msg.role === 'user', timestamp);
            });
        }

        // é‡ç½®å¯¹è¯å†å²
        function resetConversation() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¯¹è¯å†å²å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                conversationHistory = [];
                localStorage.removeItem('conversationHistory');
                messageList.innerHTML = '';
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                const originalText = resetConversationBtn.textContent;
                resetConversationBtn.textContent = 'âœ… å¯¹è¯å·²é‡ç½®';
                resetConversationBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                resetConversationBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                
                setTimeout(() => {
                    resetConversationBtn.innerHTML = '<i class="fa fa-trash mr-2"></i>é‡ç½®å¯¹è¯å†å²';
                    resetConversationBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                    resetConversationBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                }, 2000);
            }
        }

        // å¯¼å‡ºå¯¹è¯ä¸ºJSON
        function exportConversation() {
            if (conversationHistory.length === 0) {
                alert('æ²¡æœ‰å¯¹è¯å†å²å¯å¯¼å‡º');
                return;
            }
            
            // åˆ›å»ºå¯¼å‡ºæ•°æ®
            const exportData = {
                conversation: conversationHistory,
                exportDate: new Date().toISOString(),
                chatSettings: {
                    chatName: getSettings().chatName,
                    aiPrompt: getSettings().aiPrompt
                }
            };
            
            // åˆ›å»ºJSONæ–‡ä»¶
            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat_conversation_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            
            // æ¸…ç†
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            const originalText = exportConversationBtn.textContent;
            exportConversationBtn.textContent = 'âœ… å¯¼å‡ºæˆåŠŸ';
            exportConversationBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
            exportConversationBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            
            setTimeout(() => {
                exportConversationBtn.innerHTML = '<i class="fa fa-download mr-2"></i>å¯¼å‡ºå¯¹è¯ä¸ºJSON';
                exportConversationBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                exportConversationBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            }, 2000);
        }

        // å®šæœŸä¿å­˜å¯¹è¯å†å²
        setInterval(() => {
            if (conversationHistory.length > 0) {
                saveConversationHistory();
            }
        }, 30000);

        // é¡µé¢ç¦»å¼€æ—¶ä¿å­˜
        window.addEventListener('beforeunload', () => {
            saveConversationHistory();
        });
    </script>
</body>
</html>
